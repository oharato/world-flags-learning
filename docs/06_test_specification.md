# テスト仕様書

## 概要
このプロジェクトでは、Vitestを使用して包括的なユニットテストとコンポーネントテストを実装しています。

## テスト環境
- **テストフレームワーク**: Vitest v4.0.8
- **テストユーティリティ**: @vue/test-utils (Vue コンポーネントテスト用)
- **DOM環境**: happy-dom (軽量なDOM実装)
- **型定義**: @cloudflare/workers-types (Cloudflare Workers/D1対応)

## テスト結果サマリー

✅ **合計95テスト中95テスト合格** (100%の合格率)

### テストファイル別結果
- ✅ **countries.test.ts**: 14/14合格 - Countriesストアの全機能
- ✅ **quiz.test.ts**: 11/11合格 - クイズストアの全機能  
- ✅ **ranking.test.ts**: 7/7合格 - ランキングストアの全機能
- ✅ **validation.test.ts**: 16/16合格 - バリデーションとセキュリティ
- ✅ **server.test.ts**: 10/10合格 - APIロジックとバリデーション
- ✅ **Home.test.ts**: 8/8合格 - ホーム画面コンポーネント
- ✅ **QuizSetup.test.ts**: 14/14合格 - クイズ設定コンポーネント
- ✅ **Study.test.ts**: 15/15合格 - 学習モードコンポーネント

## テストコマンド

```bash
# ウォッチモードでテストを実行
npm test

# テストを1回だけ実行
npm run test:run

# UIモードでテストを実行
npm run test:ui

# カバレッジレポート付きでテストを実行
npm run test:coverage
```

## テストファイル構成

```
src/
├── store/
│   └── __tests__/
│       ├── countries.test.ts    # Countriesストアのテスト (14テスト)
│       ├── quiz.test.ts         # クイズストアのテスト (11テスト)
│       └── ranking.test.ts      # ランキングストアのテスト (7テスト)
├── utils/
│   └── __tests__/
│       └── validation.test.ts   # バリデーション関数のテスト (16テスト)
└── views/
    └── __tests__/
        ├── Home.test.ts         # ホーム画面のテスト (8テスト)
        ├── QuizSetup.test.ts    # クイズ設定画面のテスト (14テスト)
        └── Study.test.ts        # 学習モードのテスト (15テスト)

functions/
└── api/
    └── __tests__/
        └── server.test.ts       # APIロジックのテスト (10テスト)
```

## テスト内容

### 1. Countries Store テスト (`src/store/__tests__/countries.test.ts`) - 14テスト

#### 初期状態のテスト
- デフォルト値の確認（countries, loading, error, currentLanguage）

#### fetchCountries のテスト
- 日本語の国データを正常に取得できることを確認
- 英語の国データを正常に取得できることを確認
- エラー発生時にエラーメッセージが設定されることを確認
- ネットワークエラー時にエラーメッセージが設定されることを確認
- 既にデータがある場合、forceReload=false では再取得しないことを確認
- forceReload=true の場合、既にデータがあっても再取得することを確認

#### setLanguage のテスト
- 言語変更時にデータが再取得されることを確認
- 同じ言語を設定しても再取得しないことを確認

#### ゲッターのテスト
- getCountryById で指定したIDの国を取得できることを確認
- getCountryById で存在しないIDを指定するとundefinedが返ることを確認
- getRandomCountries で指定した数のランダムな国を取得できることを確認
- getRandomCountries で excludeId を指定すると、その国が除外されることを確認
- 複数の首都を持つ国のデータも正しく扱えることを確認

### 2. Quiz Store テスト (`src/store/__tests__/quiz.test.ts`) - 11テスト

#### 初期状態のテスト
- デフォルト値の確認（nickname, quizFormat, quizRegion, numberOfQuestions など）

#### setupQuiz のテスト
- クイズ設定（ニックネーム、形式、地域、問題数）が正しく保存されることを確認

#### generateQuestions のテスト
- 指定された問題数の問題が生成されることを確認
- 各問題に4つの選択肢があることを確認
- 正解が選択肢に含まれることを確認
- 地域フィルタリングが正しく動作することを確認
- 「すべて」を選択した場合、利用可能な全ての国で問題が生成されることを確認

#### startQuiz のテスト
- クイズ開始時に状態が正しくリセットされることを確認
- startTime が設定されることを確認

#### answerQuestion のテスト
- 正解時に correctAnswers が増加することを確認
- 不正解時に correctAnswers が増加しないことを確認
- 回答履歴が正しく記録されることを確認
- 全問回答後にクイズが終了することを確認

#### ゲッターのテスト
- totalTime が正しく計算されることを確認
- finalScore が正しく計算されることを確認（スコア = 正解数 × 1000 - 時間 × 10）

### 2. Ranking Store テスト (`src/store/__tests__/ranking.test.ts`)

#### 初期状態のテスト
- デフォルト値の確認（ranking, myRank, loading, error, currentRegion, currentType, currentFormat）

#### fetchRanking のテスト
- ランキングを正常に取得できることを確認
- 取得したデータが正しく格納されることを確認
- currentRegion, currentType, currentFormat が更新されることを確認
- エラー時にエラーメッセージが設定されることを確認
- ネットワークエラー時にエラーメッセージが設定されることを確認

#### submitScore のテスト
- スコアを正常に送信できることを確認
- 送信後に myRank が設定されることを確認
- 送信時に正しいパラメータ（nickname, score, region, format）が渡されることを確認
- エラー時にエラーメッセージが設定されることを確認

### 4. Validation テスト (`src/utils/__tests__/validation.test.ts`) - 16テスト

#### validateNickname のテスト

**正常系**
- 正常なニックネーム（英数字）を受け入れる
- 日本語のニックネームを受け入れる
- 20文字のニックネームを受け入れる
- 特殊文字（アンダースコア、ハイフン）を受け入れる
- 数字のみのニックネームを受け入れる
- 絵文字を含むニックネームを受け入れる

**異常系**
- 空文字列を拒否する
- 空白のみの文字列を拒否する
- 21文字以上のニックネームを拒否する

**セキュリティテスト**
- HTMLタグを含むニックネームを拒否する
- `<` を含むニックネームを拒否する
- `>` を含むニックネームを拒否する
- `javascript:` を含むニックネームを拒否する
- イベントハンドラー（`onclick=`など）を含むニックネームを拒否する
- 制御文字を含むニックネームを拒否する

**その他**
- 前後の空白をトリミングする

### 5. API Server テスト (`functions/api/__tests__/server.test.ts`) - 10テスト

#### バリデーションテスト
- 正常なデータを受け入れる
- 21文字以上のニックネームを拒否する
- 負のスコアを拒否する
- 不正なフォーマット（flag-to-name, name-to-flag 以外）を拒否する

#### セキュリティテスト
- XSS攻撃パターン（`<script>`、`javascript:`、`onclick=`など）を検出する
- 制御文字を検出する

#### スコア計算テスト
- 正解数とタイムからスコアを正しく計算する
- スコアが負にならないことを確認
- 満点の場合のスコアを確認

### 6. Home コンポーネントテスト (`src/views/__tests__/Home.test.ts`) - 8テスト

#### 基本レンダリング
- コンポーネントが正しくマウントされることを確認
- タイトル「国旗学習アプリ」が表示されることを確認

#### 言語選択機能
- 言語選択ドロップダウンが表示されることを確認
- デフォルトで日本語が選択されていることを確認
- 言語を変更するとストアが更新されることを確認

#### ナビゲーションリンク
- クイズへのリンクが正しく表示されることを確認
- 学習モードへのリンクが正しく表示されることを確認
- ランキングへのリンクが正しく表示されることを確認
- すべてのナビゲーションボタン（3つ）が表示されることを確認

### 7. QuizSetup コンポーネントテスト (`src/views/__tests__/QuizSetup.test.ts`) - 14テスト

#### 基本レンダリング
- コンポーネントが正しくマウントされることを確認

#### localStorage連携
- localStorageに保存されたニックネームを読み込むことを確認

#### 入力フォーム
- クイズ形式の選択ができることを確認
- 出題範囲の選択ができることを確認
- 問題数の選択ができることを確認（5問/10問/30問/すべて）

#### バリデーション
- ニックネームが空の場合、アラートが表示されることを確認
- ニックネームが21文字以上の場合、アラートが表示されることを確認
- HTMLタグを含むニックネームは拒否されることを確認
- 正常なニックネームでクイズが開始されることを確認
- ニックネームの前後の空白がトリミングされることを確認

#### UI状態管理
- 利用可能な大陸が正しく表示されることを確認
- 国データがロード中の場合、ボタンが無効化されることを確認
- 国データがない場合、ボタンが無効化されることを確認
- エラーが発生した場合、ボタンが無効化されることを確認

### 8. Study コンポーネントテスト (`src/views/__tests__/Study.test.ts`) - 15テスト

#### 基本レンダリング
- コンポーネントが正しくマウントされることを確認
- 最初の国が表示されることを確認
- カウンター表示が正しいことを確認

#### カードフリップ機能
- カードをクリックするとフリップすることを確認

#### ナビゲーション
- 「次へ」ボタンで次の国に移動することを確認
- 「前へ」ボタンで前の国に移動することを確認
- 最後の国で「次へ」を押すと最初に戻ることを確認（ループ）
- 最初の国で「前へ」を押すと最後に移動することを確認（ループ）

#### キーボードショートカット
- 矢印キー（→）で次の国に移動することを確認
- 矢印キー（←）で前の国に移動することを確認
- スペースキーでカードがフリップすることを確認

#### 地域フィルタリング
- 地域選択ドロップダウンが表示されることを確認
- 地域を選択するとフィルタリングされることを確認
- 地域を変更するとカードが表面に戻ることを確認

#### データ表示
- 複数の首都を持つ国の場合、最初の首都が表示されることを確認
- ローディング中は読み込みメッセージが表示されることを確認
- エラー時はエラーメッセージが表示されることを確認
- 国データがない場合、メッセージが表示されることを確認

## 型安全性の確保

このプロジェクトでは、TypeScript の厳格な型チェックを活用し、実行時エラーを防ぐための型安全性を確保しています。

### 実装された型安全対策

#### 1. Cloudflare Workers 型定義
- **@cloudflare/workers-types**: Cloudflare D1 Database の型定義を導入
- **D1Database**: クエリ結果に型パラメータを適用（`all<T>()`, `first<T>()`）
- **カスタムインターフェース**: RankingRow, ScoreRow, RankRow を定義

#### 2. 外部ライブラリの型定義
- **wikijs**: 型定義が不足しているため、WikiPage と WikiInstance インターフェースを追加
- **型アサーション**: `as unknown as WikiInstance` で型の安全性を保ちつつ柔軟性を確保

#### 3. null 安全性の強化
- **Nullish Coalescing**: `state.questions[state.currentQuestionIndex] ?? null` で安全なデフォルト値を提供
- **Non-null Assertion**: テストコードでは `!` 演算子で確実に値が存在する場合に使用
- **ランタイムガード**: `if (!currentQuestion) return;` でランタイムエラーを防止

#### 4. 配列アクセスの型安全性
- **配列の境界チェック**: インデックスアクセス時の undefined チェックを徹底
- **find() の結果チェック**: `Array.find()` の結果が undefined になり得ることを考慮

### テストにおける型安全性

- **モックデータのフィクスチャ化**: `src/__tests__/fixtures/countries.ts` で型付きモックデータを一元管理
- **テスト用非null アサーション**: テスト環境で値が保証される場合に `!` を使用
- **globalThis.fetch のモック**: グローバルな fetch API を型安全にモック化

## テストカバレッジ

主要なビジネスロジックをカバー：
- ✅ Piniaストア（状態管理） - 32テスト
- ✅ Vueコンポーネント（UI/UX） - 37テスト
- ✅ バリデーション関数 - 16テスト
- ✅ スコア計算ロジック - 10テスト
- ✅ セキュリティチェック（XSS対策）
- ✅ 型安全性（TypeScript strict mode）

### コードリファクタリング

テスト実装と並行して、以下のコード品質改善を実施しました：

1. **不要なコメントの削除**: 自明な処理の説明コメントを削除し、コードの可読性を向上
2. **共通モックデータの抽出**: `src/__tests__/fixtures/countries.ts` に集約し、重複を排除
3. **テスト設定の最適化**: `vitest.config.ts` と `vitest.setup.ts` を簡潔に整理
4. **fetch モックの統一**: `global.fetch` から `globalThis.fetch` に統一

## 今後の拡張

以下のテストを追加することで、より堅牢なテストスイートを構築できます：

1. **E2Eテスト**: Playwright や Cypress を使用した統合テスト
2. **視覚的回帰テスト**: スクリーンショット比較によるUIテスト
3. **パフォーマンステスト**: 大量のデータでのパフォーマンステスト
4. **アクセシビリティテスト**: WCAG準拠のチェック

## 注意事項

- テストは `__tests__` ディレクトリに配置します
- テストファイル名は `*.test.ts` または `*.spec.ts` の形式にします
- モックやスタブを適切に使用してテストを独立させます
- 各テストは他のテストに依存しないようにします
