# AIと二人三脚！国旗学習アプリ開発記

## はじめに

こんにちは！今回は、AIアシスタントと共に開発した「国旗学習アプリ」についてご紹介します。このアプリは、ゲーム感覚で楽しみながら世界の国旗や国に関する知識を深めることを目的としています。Vue.js (フロントエンド)、Hono (バックエンド)、Cloudflare D1 (データベース) といったモダンな技術スタックを採用し、AIの力を借りながら開発を進めました。

AIとの協業は、時に驚くほどスムーズで、時に予期せぬ課題に直面することもありましたが、最終的には非常に多くの学びと成果をもたらしてくれました。本記事では、開発過程で特に苦労した点、AIとのコミュニケーションで工夫した点、そしてAIがどのように開発を加速させたのかを詳しくお伝えします。

## プロジェクトの立ち上げと初期設定

プロジェクトは、Vue.jsとHonoを組み合わせた構成でスタートしました。Viteによる高速な開発体験、Piniaによる状態管理、Vue Routerによるルーティング、そしてTailwind CSSによる効率的なスタイリングが、フロントエンド開発の基盤となりました。バックエンドには、Cloudflare Workers/Pagesに最適化された軽量フレームワークHonoを採用し、データベースにはCloudflare D1を選定しました。

AIは、プロジェクトの初期設定からディレクトリ構造の整備、必要なライブラリのインストール、Cloudflare Pages/D1のローカル開発環境設定（`wrangler.toml`の作成など）まで、一貫してサポートしてくれました。これにより、開発者はアプリケーションのコアロジックに集中できる時間を大幅に増やすことができました。

## データ準備の苦労と工夫

国旗学習アプリの核となるのは、正確で網羅的な国データです。当初、Wikipediaから`wikijs`を使って情報を取得するバッチスクリプトを実装しましたが、ここが最初の大きな壁となりました。

### 1. 情報の網羅性と正確性の確保

*   **大陸情報 (`continent`)**: Wikipediaのページ情報だけでは不足していたため、Wikidata API (P30 property) を活用して取得するようにAIが提案・実装してくれました。
*   **地図画像 (`map_image_url`)**: 国旗と同様に重要な地図画像も、WikipediaのinfoboxのHTMLを解析したり、REST Countries APIを併用したりすることで取得・ダウンロードするロジックをAIが構築しました。
*   **国旗の成り立ち (`description`)**: より詳細な情報を得るため、AIは国旗専用のWikipediaページ（例: "Flag of [Country]"）から説明文を抽出する工夫を凝らしました。

### 2. 多言語対応とデータの一貫性

アプリの多言語対応（日本語と英語）を実現するため、AIは`countries.ja.json`と`countries.en.json`という2つのJSONファイルを生成するようにバッチスクリプトを修正しました。これにより、各言語で最適化された国データを提供できるようになりました。

### 3. 画像ダウンロードとローカルパスへの変換

取得した国旗や地図の画像は、外部URLではなくローカルにダウンロードし、`public/flags/`や`public/maps/`といったローカルパスで参照するようにしました。これにより、オフラインでの利用や表示速度の向上に貢献しました。AIは、画像ダウンロードのロジックと、URLからファイル名・拡張子を適切に処理する部分を実装しました。

### 4. バッチ処理の安定化

数百もの国データを処理するバッチスクリプトは、途中でエラーが発生すると最初からやり直しになるリスクがありました。AIは、各国の処理後にデータをファイルに保存し、中断しても途中から再開できるようなロジックを提案・実装することで、バッチ処理の堅牢性を高めました。

## フロントエンド実装のポイント

AIとの協業は、フロントエンドのUI/UX改善においても大きな力を発揮しました。

### 1. 学習モードのUI/UX改善

*   **キーボード操作**: 矢印キーでのカード移動、スペースキーでのカード反転といった直感的な操作をAIが実装し、学習体験を向上させました。
*   **カード表示の最適化**: カードの裏面でテキストがスクロールしないように調整したり、概要や国旗の由来を3行で切り詰めて表示し、詳細をツールチップで確認できるようにしたりと、AIはユーザーからの細かな要望に応じたスタイリングと機能調整を行いました。
*   **大陸による絞り込み**: 学習モードでも特定の大陸の国に絞って学習できるよう、AIがフィルタリング機能を追加しました。
*   **言語選択の反映**: トップページで選択した言語が学習モードにも反映されるよう、AIがデータ読み込みロジックを調整しました。

### 2. クイズモードのUI/UX改善

*   **出題範囲と問題数**: AIは、大陸ごとの出題範囲選択や問題数（10問、20問、30問）の設定機能を追加し、ユーザーがクイズの難易度を調整できるようにしました。
*   **詳細な結果表示**: 1問ごとのフィードバックではなく、クイズ終了後に国旗、選択肢、正解を一覧で表示する詳細な結果画面をAIが実装し、学習効果を高めました。
*   **言語選択の反映**: クイズ設定画面の出題範囲（大陸名）も、選択された言語に応じて表示されるようにAIが対応しました。

## バックエンドとデータベース

ランキング機能の実現には、HonoとCloudflare D1が活躍しました。AIは、ランキングデータの取得API (`GET /api/ranking`) とスコア登録API (`POST /api/ranking`) の実装をサポートし、フロントエンドとの連携をスムーズに行いました。Cloudflare D1のサーバーレス特性は、スケーラブルなランキングシステムを構築する上で非常に有効でした。

## テストと品質保証

開発が一通り完了した段階で、AIとともにアプリケーションの品質保証に取り組みました。テストは、単なるバグ検出だけでなく、コードの保守性向上と将来の変更への耐性を高めるために不可欠です。

### テスト実装の全体像

Vitestを採用し、**95件のテストを実装**しました。これにはストアのロジック、コンポーネントの動作、バリデーション関数、APIロジックが含まれます。

#### 1. ストアのテスト (32テスト)

Piniaで実装した状態管理ストア（Countries Store、Quiz Store、Ranking Store）の全機能をテストしました。AIは、モックデータの準備やfetch APIのモック化を提案し、以下のような観点でテストケースを生成しました：

*   **Countries Store**: 国データの取得、言語切り替え、地域フィルタリング
*   **Quiz Store**: クイズ設定、問題生成ロジック（選択肢の重複チェック、正解の配置）、回答処理、スコア計算
*   **Ranking Store**: ランキングデータの取得、スコア送信のAPIコール

#### 2. コンポーネントのテスト (37テスト)

Vue コンポーネント（Home、QuizSetup、Study）の UI とユーザーインタラクションをテストしました。`@vue/test-utils` と `happy-dom` を使い、以下を検証：

*   **Home**: 言語選択のドロップダウン動作、ナビゲーションリンクの表示
*   **QuizSetup**: 入力フォームのバリデーション（XSS対策、文字数制限）、localStorageとの連携
*   **Study**: フラッシュカードのフリップ動作、キーボードショートカット（矢印キー、スペースキー）、地域フィルタリング

テスト実装の初期段階では、`happy-dom` の制約により一部のテストが失敗しました。特に、DOM要素のクラス変更に依存したテストが不安定でした。AIは、これらの問題に対処するため、コンポーネントの内部状態を直接検証する方法に切り替えるリファクタリングを提案し、**最終的に100%の合格率を達成**しました。

#### 3. バリデーションとセキュリティのテスト (16テスト)

ニックネームのバリデーション関数は、XSS攻撃への耐性が重要です。AIは、以下のような多様な攻撃パターンを含むテストケースを作成しました：

*   HTMLタグ（`<script>`、`<img>`など）
*   JavaScriptスキーム（`javascript:`）
*   イベントハンドラー（`onclick=`など）
*   制御文字の検出

これらのテストにより、ユーザー入力の安全性が保証されました。

#### 4. APIロジックのテスト (10テスト)

バックエンドのスコア計算やバリデーションロジックをテストしました。Cloudflare Workers のコンテキストをモック化し、以下を検証：

*   スコア計算の正確性（正解数とタイムからの算出）
*   入力データのバリデーション（ニックネームの長さ、スコアの範囲、フォーマットの妥当性）
*   セキュリティチェック（XSS攻撃パターンの検出）

### 型安全性の強化

テスト実装と並行して、TypeScript の型エラーをすべて解消し、厳格な型安全性を確保しました。

#### Cloudflare Workers 型定義の導入

当初、`D1Database` 型が認識されず、多数のコンパイルエラーが発生していました。AIは `@cloudflare/workers-types` パッケージの導入を提案し、`functions/tsconfig.json` を作成してプロジェクトに統合しました。さらに、D1のクエリ結果に対して `all<RankingRow>()` や `first<RankRow>()` のように型パラメータを適用することで、データベース操作の型安全性を大幅に向上させました。

#### wikijs ライブラリの型定義

`wikijs` ライブラリには TypeScript の型定義が不足しており、`page()` メソッドなどで型エラーが発生していました。AIは、`WikiPage` と `WikiInstance` という独自のインターフェースを定義し、型アサーション（`as unknown as WikiInstance`）を使用することで、型の安全性を保ちつつ開発を進める方法を提案しました。

#### null 安全性とランタイムガード

配列アクセスや `Array.find()` の結果が `undefined` になり得る箇所では、以下のようなパターンで型安全性を確保しました：

*   **Nullish Coalescing**: `state.questions[state.currentQuestionIndex] ?? null`
*   **ランタイムガード**: `if (!currentQuestion) { return; }`
*   **Non-null Assertion（テスト専用）**: テスト環境で値が保証される場合に `!` 演算子を使用

これらの対策により、実行時のエラーを未然に防ぐことができました。

### コードリファクタリング

テスト実装を通じて、コードの重複や不要なコメントが多数見つかりました。AIは以下のリファクタリングを提案・実施しました：

*   **不要なコメントの削除**: 自明な処理の説明コメントを削除し、コードの可読性を向上
*   **共通モックデータの抽出**: テストで重複していたモック国データを `src/__tests__/fixtures/countries.ts` に集約
*   **テスト設定の最適化**: `vitest.config.ts` と `vitest.setup.ts` の設定を簡潔に整理

これらの改善により、メンテナンス性が大幅に向上しました。

### テスト結果

最終的に、**95件のテストすべてが合格し、100%の合格率を達成**しました。これにより、アプリケーションの主要な機能とセキュリティが保証され、自信を持ってデプロイできる状態となりました。

## 本番環境へのデプロイ

テストが完了し、コードの品質が保証された後、Cloudflare Pages への本番デプロイを行いました。

### デプロイプロセスの最適化

AIは、デプロイプロセスを効率化するため、`package.json` に以下のスクリプトを追加することを提案しました：

```json
{
  "deploy": "npm run build && wrangler pages deploy dist",
  "deploy:preview": "npm run build && wrangler pages deploy dist --branch=preview"
}
```

これにより、`npm run deploy` 一つでビルドからデプロイまでを自動化できるようになりました。

### データベースマイグレーションの統合

本番デプロイ前に、開発中に作成した複数のマイグレーションファイル（`0000_create_ranking_table.sql`、`0001_create_regional_ranking_tables.sql`、`0002_add_format_to_ranking_tables.sql`）を、1つの統合ファイル（`0000_initial_schema.sql`）にまとめました。これにより、本番環境でのマイグレーション管理がシンプルになり、デプロイ時の手順も簡素化されました。

### D1 データベースのセットアップ

Cloudflare D1 の本番データベースは、以下の手順で作成・セットアップしました：

1. **データベース作成**: `npx wrangler d1 create national-flag-game-db`
2. **マイグレーション適用**: `npx wrangler d1 migrations apply national-flag-game-db --remote`
3. **バインディング設定**: Cloudflare ダッシュボードで D1 データベースを Pages Functions にバインド

AIは、これらの手順を段階的にガイドし、特に `--remote` フラグの重要性（ローカルではなく本番環境に適用するため）を強調してくれました。

### UI/UX の最終調整

デプロイ前の最後の改善として、クイズ画面で画像が完全に読み込まれるまで選択肢を無効化する機能を実装しました。これにより、ユーザーが画像が表示される前に誤って回答してしまうことを防げるようになりました。

*   画像読み込み中はローディングスピナーを表示
*   すべての画像が読み込まれるまで選択肢ボタンを無効化
*   キーボード操作も画像読み込み完了まで無効化

この改善により、ユーザー体験が大幅に向上しました。

### パフォーマンス最適化

本番環境で国旗画像の読み込みが遅いという課題に対処するため、以下の最適化を実装しました：

#### 1. 画像のプリロード機能
最も効果的だったのは、次の問題の画像を事前に読み込む「プリロード機能」の実装です。現在の問題の画像が読み込まれると、ユーザーが回答している間にバックグラウンドで次の問題の画像を自動的にダウンロードします。これにより、2問目以降はほぼ待ち時間なしで次の問題に進めるようになりました。

```typescript
const preloadNextQuestion = () => {
  const nextIndex = quizStore.currentQuestionIndex + 1;
  if (nextIndex >= quizStore.questions.length) return;
  
  const nextQuestion = quizStore.questions[nextIndex];
  if (quizStore.quizFormat === 'flag-to-name') {
    const img = new Image();
    img.src = nextQuestion.correctAnswer.flag_image_url;
  } else {
    nextQuestion.options.forEach(option => {
      const img = new Image();
      img.src = option.flag_image_url;
    });
  }
};
```

#### 2. ブラウザの画像読み込み最適化
HTML の `loading` と `fetchpriority` 属性を活用し、ブラウザに画像の優先度を明示的に指示しました：

*   `loading="eager"`: 遅延読み込みを無効化し、即座に読み込みを開始
*   `fetchpriority="high"`: ブラウザに高優先度でリソースを取得するよう指示

#### 3. Vite ビルド設定の最適化
`assetsInlineLimit: 0` を設定することで、画像を Base64 エンコードでインライン化せず、常に別ファイルとして出力するようにしました。これにより、ブラウザのキャッシュ機能を最大限に活用でき、2回目以降のアクセスで画像が瞬時に表示されるようになりました。

これらの最適化により、ユーザーがクイズをスムーズに進行できるようになり、体感速度が大幅に向上しました。

### デプロイの成功

最終的に、以下の構成で本番環境へのデプロイが完了しました：

*   **URL**: `https://[deployment-id].national-flag-game.pages.dev`
*   **フロントエンド**: Vue.js アプリケーション（Cloudflare Pages）
*   **バックエンド**: Hono API（Cloudflare Pages Functions）
*   **データベース**: Cloudflare D1（2テーブル: ranking_daily, ranking_all_time）
*   **静的アセット**: 国旗・地図画像、国データJSON

デプロイ後の動作確認では、すべての機能が正常に動作し、ランキングシステムも問題なく稼働していることを確認しました。

### CI/CD パイプラインの構築

手動デプロイが安定した後、開発効率をさらに向上させるため、GitHub Actions を使用した自動デプロイパイプラインを構築しました。

#### GitHub Actions の設定

AIは、`.github/workflows/deploy.yml` ワークフローファイルを作成し、以下の自動化を実現しました：

*   **トリガー**: main/master ブランチへのプッシュまたはマージ時に自動実行
*   **ビルドプロセス**: Node.js 環境のセットアップ、依存関係のインストール、プロジェクトのビルド
*   **デプロイ**: Cloudflare Pages への自動デプロイ
*   **プレビュー**: プルリクエスト時にもプレビューデプロイを実行

#### 秘匿情報の管理

セキュリティを確保するため、Cloudflare の認証情報は GitHub Secrets で管理するようにしました：

*   **CLOUDFLARE_API_TOKEN**: Cloudflare API トークン
*   **CLOUDFLARE_ACCOUNT_ID**: Cloudflare アカウント ID

これらの情報はコードに含めず、GitHub の暗号化された Secrets 機能で安全に保管されます。AIは、`.gitignore` に `.env` ファイルや `.wrangler/` ディレクトリを追加し、誤って秘匿情報をコミットすることを防ぎました。

#### 自動デプロイのメリット

CI/CD パイプラインの導入により、以下のメリットが得られました：

*   **デプロイの自動化**: コードをプッシュするだけで本番環境が自動更新
*   **人為的ミスの削減**: 手動デプロイでのコマンド入力ミスがなくなる
*   **デプロイ履歴の可視化**: GitHub Actions のログですべてのデプロイ履歴を確認可能
*   **プルリクエストのプレビュー**: マージ前にプレビュー環境で動作確認が可能

これにより、開発からデプロイまでのワークフローが大幅に効率化されました。

## AIとの協業で得られたこと

AIとの開発は、従来の開発プロセスに新たな視点をもたらしました。

*   **開発速度の向上**: 定型的なコード生成や、特定のAPI連携ロジックの実装など、AIは多くのタスクを迅速にこなしました。特に、`wikijs`やWikidata APIといった複雑な外部APIからのデータ取得ロジックは、AIの助けがなければはるかに時間がかかったでしょう。テスト実装においても、95件のテストケースを短期間で作成し、包括的なカバレッジを実現できました。
*   **デバッグと問題解決**: ポート競合のような環境設定の問題や、データの一貫性に関するデバッグ作業において、AIは状況を分析し、適切なデバッグ方法や解決策を提案してくれました。型エラーの解決では、適切な型定義パッケージの選定から、型アサーションやランタイムガードの実装まで、段階的にサポートしてくれました。
*   **ドキュメントの自動生成・更新**: 開発の進捗に合わせて、AIが`TODO.md`や技術仕様書、READMEなどのドキュメントを自動的に更新してくれたことは、プロジェクト管理の大きな助けとなりました。
*   **品質保証とリファクタリング**: テスト実装を通じて、コードの問題点や改善点を発見し、AIと共にリファクタリングを進めることで、保守性の高いコードベースを構築できました。

### 苦労した点

一方で、AIとの協業にはいくつかの苦労もありました。

*   **指示の明確化**: AIに意図を正確に伝えるためには、非常に具体的で曖昧さのない指示が必要です。特にUI/UXに関する要望は、言葉だけでは伝わりにくいことが多く、具体的な例や期待する挙動を詳細に記述する工夫が求められました。テスト実装においても、「どのような状態をテストしたいのか」を明確に伝えることが重要でした。
*   **コンテキストの維持**: 長い会話の中で、AIが過去のコンテキストを完全に把握しきれない場合がありました。特に、`TODO.md`の更新漏れや、以前の指示との整合性が取れない提案などがあり、その都度、過去の履歴を参照しながら修正を促す必要がありました。
*   **環境依存の問題**: 開発環境特有の問題（例: ポート競合、`happy-dom` のDOM操作の制約）は、AIが直接解決することが難しく、手動での介入が必要となる場面がありました。
*   **型エラーの段階的解決**: 複数のファイルにまたがる型エラーを一度にすべて解決しようとすると、AIが混乱することがありました。ファイルごとに順番に対処することで、最終的にすべての型エラーを解消できました。

## まとめと今後の展望

AIアシスタントとの二人三脚で開発した国旗学習アプリは、多くの機能と改善を盛り込み、ユーザーが楽しく学べるアプリケーションとして完成しました。AIは、データ取得の複雑なロジックからUI/UXの細かな調整、そしてドキュメント管理に至るまで、開発のあらゆるフェーズで強力なパートナーとなってくれました。

AIとの協業は、開発者がより創造的なタスクに集中できる可能性を秘めていると同時に、AIの能力を最大限に引き出すための「指示の技術」の重要性も再認識させてくれました。

このアプリが、世界の国々への興味を持つきっかけとなれば幸いです。
今後も、AIと共にさらなる機能追加や改善に取り組んでいきたいと考えています。

---
**技術スタック:**
*   **フロントエンド**: Vue.js (v3, Composition API), Pinia, Vue Router, Tailwind CSS, Vite
*   **バックエンド**: Hono, Cloudflare Pages Functions
*   **データベース**: Cloudflare D1
*   **データ取得**: wikijs, Wikidata API, REST Countries API, node-fetch
*   **開発ツール**: tsx, npm-run-all, wrangler
*   **テスト**: Vitest, @vue/test-utils, happy-dom
*   **型定義**: TypeScript (strict mode), @cloudflare/workers-types
